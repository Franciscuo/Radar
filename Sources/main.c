#include <hidef.h> /* for EnableInterrupts macro */
#include "derivative.h" /* include peripheral declarations */

#define LRESET	PTCD_PTCD5

#define GLCD_CS1     PTBD_PTBD1	  // Chip Selection 1GLCD_CS2     PIN_B1   // Chip Selection 2
#define GLCD_CS2     PTBD_PTBD0   // Chip Selection 2
#define GLCD_RST     PTBD_PTBD2	  // RESET
#define GLCD_RS      PTBD_PTBD3	 //Data or Instruction input
#define GLCD_E       PTBD_PTBD4   // Enable



const char tabla[1024] = {     
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0xC0, 0x40, 0x60, 0x20, 0x20, 0x30, 0x30, 0x10,
0x18, 0x18, 0x08, 0x08, 0x08, 0x0C, 0x0C, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x06,
0x06, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x0C, 0x0C, 0x08, 0x08, 0x08, 0x18, 0x18,
0x10, 0x30, 0x30, 0x20, 0x20, 0x60, 0x40, 0xC0, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0x60, 0x30, 0x10, 0x18, 0x08,
0x0C, 0x06, 0x02, 0x03, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80,
0x80, 0xC0, 0x40, 0x40, 0x40, 0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x30, 0x30, 0x30, 0x10,
0x10, 0x30, 0x30, 0x30, 0x30, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x60, 0x40, 0x40, 0x40, 0x80,
0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x03, 0x02, 0x06, 0x0C,
0x08, 0x18, 0x10, 0x30, 0x60, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x80, 0xC0, 0x60, 0x20, 0x30, 0x10, 0x08, 0x0C, 0x04, 0x06, 0x02, 0x03, 0x01, 0x01, 0x01, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x01, 0x01, 0x03, 0x02, 0x06, 0x04, 0x04, 0x08, 0x18, 0x10, 0x20, 0x60, 0x40, 0x80,
0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0x70, 0x18, 0x0E, 0x07,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x40, 0x60, 0x20, 0x10, 0x10, 0x08, 0x08, 0x04,
0x04, 0x06, 0x02, 0x02, 0x03, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 0x02, 0x02, 0x04,
0x04, 0x0C, 0x08, 0x18, 0x10, 0x30, 0x20, 0x40, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x01, 0x03, 0x06, 0x04, 0x08, 0x10, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
0x07, 0x0E, 0x18, 0x70, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0x3C, 0x0E, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x80, 0x60, 0x38, 0x0C, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
0x60, 0x30, 0x18, 0x04, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x40,
0x60, 0x20, 0x10, 0x10, 0x18, 0x08, 0x08, 0x0C, 0x04, 0x04, 0x04, 0x06, 0x06, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x06, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x08, 0x08, 0x10, 0x10, 0x30, 0x20,
0x40, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x04, 0x08, 0x18, 0x20,
0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x04, 0x18, 0x70, 0xC0, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0E, 0x3C, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0xC0, 0xF8, 0x1E, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0,
0x18, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x30, 0x1C, 0x06, 0x01, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x60, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x40, 0x60, 0x20, 0x20, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x30, 0x20, 0x20, 0x40, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x01, 0x03, 0x06, 0x0C, 0x18, 0x30, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x01, 0x03, 0x0C, 0x38, 0xE0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0C,
0x70, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1E, 0xF8, 0xC0, 0x00, 0x00, 0x00,
0x00, 0x80, 0xFC, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xF8, 0x07, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x3C, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0xE0, 0x38, 0x0E, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x60, 0x18,
0x0C, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xC0, 0x40, 0x40,
0x40, 0x40, 0x40, 0xC0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x06, 0x0C,
0x18, 0x30, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x1C, 0xF0, 0x80, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1E, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x03, 0x3E, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFC, 0x80, 0x00,
0x00, 0xFF, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xC0, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0x0F, 0x01, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0x0C, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x0C, 0x38, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x07, 0xFC, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xF8,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xFF, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x9F, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x87, 0xFF, 0x00
};

unsigned long TIEMPOX , i, dato;
volatile unsigned int bandera=0;
volatile unsigned long N[183]={400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,400,
		                       400,400,400,
};
//-------Funciones LCD---------
void tiempo(long t){
	for(i=0;i<t;i++);
	return;	
}

void lcd_pulso(){
   GLCD_E=1;       // Pulse the enable pin
   tiempo(2);
   GLCD_E=0;
   tiempo(2);
   return;
}

void lcd_comando(char data){
   GLCD_RS=0;
   PTED=data;
   lcd_pulso();
   return;
}

void lcd_dato(char data){
   GLCD_RS=1;
   PTED=data;
   lcd_pulso();
   return;
}
void lcd_chip(char b){
	if(b==1){
    GLCD_CS1=0;      // Reset the chip select lines
    GLCD_CS2=1;
}else{
	 GLCD_CS1=1;      // Reset the chip select lines
	 GLCD_CS2=0;
}
   return;
}


void lcd_init(){
         
     GLCD_RST=1;	//Reinicia LCD
     tiempo(2000);
     GLCD_RST=0;
     tiempo(2000);
     GLCD_RST=1;
     tiempo(50000);

     lcd_chip(0); //Primera Mitad Pantalla
     lcd_comando(0x3E);
     lcd_comando(0xC0);// Linea de desplegado inicial en cero
     lcd_comando(0xB8);// Y=0
     lcd_comando(0x40);// X=0
     lcd_comando(0x3F);
     
     lcd_chip(1);// Segunda Mitad Pantalla
     lcd_comando(0x3E);//Apaga el display
     lcd_comando(0xC0);// Linea de desplegado inicial en cero
     lcd_comando(0xB8);// Y=0
     lcd_comando(0x40);// X=0
     lcd_comando(0x3F);
     return;
}


void lcd_radar(){
   unsigned char cont,w;
   unsigned int index=0;//llega a 1024
   for(cont=0;cont<8;cont++){
   lcd_chip(0);//Primera Mitad
   lcd_comando(0b10111000| cont);//Pagina X seleccionada
   lcd_comando(0b11000000);//Linea 0
   for(w=0;w<64;w++){
   lcd_dato(tabla[index]);
   index++;
   }
   lcd_chip(1);//Primera Mitad
   lcd_comando(0b10111000| cont);//Pagina X seleccionada
   lcd_comando(0b11000000);//Linea 0
   for(w=0;w<64;w++){
   lcd_dato(tabla[index]);
   index++;
   }
   }
   return;
}

void lcd_clear(){
	char i, j,aux;
	GLCD_RS=0;

   for(j=0;j<8;j++){   
      lcd_chip(0);//Primera Mitad
      aux=0b10111000| j;
      lcd_comando(aux);//Pagina X seleccionada
      lcd_comando(0b11000000);//Linea 0
      for(i=0;i<64;i++){
         lcd_dato(0x00);
      }
      lcd_chip(1);//Segunda Mitad
      aux=0b10111000| j;
      lcd_comando(aux);//Pagina X seleccionada
      lcd_comando(0b11000000);//Linea 0
      for(i=0;i<64;i++){
         lcd_dato(0b00000000);//Se incrementan las posiciones y automaticamente
      }
   }
   return;
}



//---------Funciones motor--------------

void motor(void){
	if (TPM2C1V==4694){
		bandera=1;
	}
	if(TPM2C1V==1400){
		bandera=0;
	}
	if (bandera==1){
		TPM2C1V=TPM2C1V-18;
		dato=dato-1;
	}
	else{
		TPM2C1V=TPM2C1V+18;
		dato=dato+1;
	}
	
  } 
void Gdato(void){
	TIEMPOX=TIEMPOX/117;
	N[dato]=TIEMPOX;
}

void main(void) 
{
	
	SOPT1 = 0;
	MCGTRM = 0xAA; 
	MCGC1 = 6;
	while(MCGSC_LOCK == 0){}; 
	PTEDD=0xFF;//Salidas para datos LCD
	PTBDD=0xFF;//Salidas para control LCD
	PTCDD=0b00100000;
	PTFDD=0b00100001;
	PTFPE=0b00000010;
	
	LRESET=1;
	tiempo(500);
	LRESET=0;
	
	 lcd_init();//Inicializa LCD
	 //lcd_clear();//Limpia la lcd 
	 lcd_radar();// PONE IMAGEN DEL RADAR
	
	TPM1SC=0b00001010; //TIM1 Pre*4, Int. deshabilitada, TIM deshabilitado
	TPM1MOD=50000;
	TPM1C2SC=0b00101000;
	TPM1C2V=20;
	
	TPM1C3SC=0b00001100; 
	
	TPM2SC = 0b00001010; //TIM2 Pre*4, Int. deshabilitada, TIM deshabilitado
	TPM2MOD=40000;   
	TPM2C1SC=0b00101000;
	TPM2C1V=1400;
	
	dato=0;
	
	TPM1SC_CLKSA = 1;
	TPM2SC_CLKSA = 1;
	EnableInterrupts;//CLI
	
	for(;;) 
	{
		TPM1C3SC=0b00000100;
		while(TPM1C3SC_CH3F==0);
		TPM1C3SC_CH3F=1;
		
		TPM1CNT=0;
		
		TPM1C3SC=0b00001000;
		while(TPM1C3SC_CH3F==0);
		TPM1C3SC_CH3F=1;
		
		TIEMPOX=TPM1C3V;
		Gdato();
		motor();
		
	}
}
